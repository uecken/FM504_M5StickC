<!-- index.html -->
<!DOCTYPE html>
<html>
  <head>
    <title>RFID登録・探索システム</title>
    <!-- ビューポートメタタグの追加 -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body {
        font-family: 'Helvetica Neue', Arial, sans-serif;
        line-height: 1.6;
        color: #333;
        max-width: 100%;
        margin: 0;
        padding: 10px;
        box-sizing: border-box;
      }
      
      /* コンテナスタイル */
      .container {
        width: 100%;
        max-width: 100%;
        padding: 0 5px;
        margin: 0 auto;
      }
      
      /* テーブルのスタイル */
      table {
        border-collapse: collapse;
        width: 100%;
        margin-bottom: 20px;
        table-layout: fixed;
      }
      
      h1, h2 ,h3{
        text-align: center;
      }
      /* フォームのスタイル */
      #myForm {
        max-width: 800px;
        margin: 0 auto;
      }
      label {
        font-size: 18px;
      }
      textarea {
        width: 100%;
        max-width: 100%;
        height: 4em;
        max-height: 4em;
        box-sizing: border-box;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 4px;
        resize: none;
        -webkit-text-size-adjust: 100%;
        inputmode: text;
        lang: en;
      }
      /* テーブルセクションのスタイル */
      #registerSection, #querySection {
        max-width: 800px;
        margin: 20px auto 0 auto;
        padding: 10px;
        background-color: #fff;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
      }
      /* テーブルのスタイル */
      #previewTable, #rfidTable {
        border-collapse: collapse;
        width: 100%;
        margin-top: 20px;
        overflow-x: auto;
        display: block;
      }
      #previewTable th, #previewTable td,
      #rfidTable th, #rfidTable td {
        border: 1px solid #ddd;
        padding: 12px;
        font-size: 16px;
        text-align: left;
      }
      #previewTable th, #rfidTable th {
        background-color: #f2f2f2;
        font-size: 18px;
      }
      /* ボタンの共通スタイル */
      .btn {
        margin-right: 10px;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        background-color: #4CAF50;
        color: white;
        transition: background-color 0.3s;
      }
      /* ボタンホバー時のスタイル */
      .btn:hover {
        background-color: #45a049;
      }
      /* キャンセルボタンのスタイル調整 */
      .btn-cancel {
        background-color: #f44336;
      }
      .btn-cancel:hover {
        background-color: #da190b;
      }
      /* クリアボタンのスタイル調整 */
      .btn-clear {
        background-color: #555555;
      }
      .btn-clear:hover {
        background-color: #333333;
      }
      /* 削除ボタンのスタイル調整 */
      .btn-delete {
        background-color: #808080; /* 灰色 */
        color: white;
      }
      .btn-delete:hover {
        background-color: #696969; /* 少し暗い灰色 */
      }
      /* 黄色ボタンのスタイル */
      .btn-yellow {
        background-color: #FFEB3B; /* 黄色 */
        color: #000; /* 文字色を黒に設定 */
      }
      .btn-yellow:hover {
        background-color: #FDD835; /* 少し暗い黄色 */
      }
      /* 重複IDのスタイル */
      .duplicate {
        color: orange;
        font-weight: bold;
      }
      /* 発見マークのスタイル */
      .found {
        color: green;
        font-weight: bold;
      }
      /* チェックボックスのスタイルをさらに大きくする */
      .checkbox-large {
        transform: scale(2); /* スケールを1.5から2に変更 */
        margin: 5px;
      }
      /* メッセージのスタイル */
      #successMessage, #deleteSuccessMessage, #querySuccessMessage, #queryNotFoundMessage {
        display: none;
        max-width: 800px;
        margin: 20px auto;
        padding: 15px;
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        border-radius: 5px;
        font-size: 18px;
        text-align: center;
      }
      /* エラーメッセージのスタイル */
      #errorMessage {
        display: none;
        max-width: 800px;
        margin: 20px auto;
        padding: 15px;
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        border-radius: 5px;
        font-size: 18px;
        text-align: center;
      }
      /* レスポンシブデザイン */
      @media (max-width: 600px) {
        .btn {
          width: 100%;
          margin-bottom: 10px;
        }
        .preview-buttons, .action-buttons {
          display: flex;
          flex-direction: column;
          align-items: stretch;
        }
        #previewTable th, #previewTable td,
        #rfidTable th, #rfidTable td {
          font-size: 14px;
          padding: 8px;
        }
        textarea {
          font-size: 14px;
        }
        label {
          font-size: 16px;
        }
        h1, h2 {
          font-size: 24px;
        }
      }
      /* アクティブモードボタンのスタイル */
      .btn-active-on {
        background-color: #4CAF50; /* 緑色 */
        color: white;
      }

      .btn-active-off {
        background-color: #808080; /* 灰色 */
        color: white;
      }

      input[type="text"] {
        font-size: 16px; /* 16px以上にすることでiOSでの自動ズームを防ぐ */
        -webkit-text-size-adjust: 100%;
        max-width: 100%;
        -webkit-touch-callout: none;
        touch-action: manipulation;
      }

      /* 新しいスタイルを追加 */
      .editable {
        background-color: #fff;
        border: 1px solid #ddd;
        padding: 8px;
        cursor: text;
      }
      .editable:hover {
        background-color: #f5f5f5;
      }
      .editable:focus {
        background-color: #e8f0fe;
        outline: 2px solid #4CAF50;
        border: 1px solid #4CAF50;
      }
      /* モーダルのスタイル */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
      }
      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
        border-radius: 5px;
      }
      .modal-header {
        margin-bottom: 20px;
      }
      .modal-footer {
        margin-top: 20px;
        text-align: right;
      }
      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }
      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>RFID探索システム</h1>
    <h3>JANコードに紐づくRFIDタグを探索するシステム</h3>
    
    <!-- モード切り替えボタンおよびスプレッドシート参照ボタン -->
    <div style="text-align: center; margin-bottom: 20px;">
      <button type="button" class="btn" onclick="switchMode('registration')" aria-label="登録モードに切り替える">登録モード</button>
      <button type="button" class="btn btn-cancel" onclick="switchMode('query')" aria-label="照会モードに切り替える">照会モード</button>
      <button type="button" class="btn btn-yellow" onclick="window.open('https://docs.google.com/spreadsheets/d/1DpijamOOnYjeZB7M8hEKt2DzRaiL5Xr0lKqTeKPxwjs/edit?gid=0#gid=0', '_blank')" aria-label="スプレッドシートを参照">スプレッドシートを参照</button>
      <button type="button" id="activeMode" class="btn btn-active-on" onclick="toggleActiveMode()" aria-label="アクティブモードを切り替える">アクティブモード: ON</button>
    </div>
    
    <!-- RFID入力フォーム -->
    <form id="myForm">
      <label for="rfidData">スキャンしたRFID:</label><br>
      <textarea 
        id="rfidData" 
        name="rfidData" 
        rows="10" 
        placeholder="例:　E2806F12000000021FC2FF6E" 
        inputmode="none"
        lang="en"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="characters"
        spellcheck="false"
        enterkeyhint="done"
        onkeypress="return /[A-Za-z0-9]/.test(event.key)"
      ></textarea><br><br>
    </form> 

    <!-- 登録モード用プレビュー表示セクション -->
    <div id="registerSection" style="display:none;">
      <h2>登録したいRFIDリスト</h2>
      <!-- JANコード入力フォームを削除 -->
      <table id="previewTable">
        <thead>
          <tr>
            <th>JANコード</th>
            <th>RFID ID</th>
          </tr>
        </thead>
        <tbody id="previewBody">
          <!-- プレビュー内容がここに挿入されます -->
        </tbody>
      </table>
      <!-- 余白の追加 -->
      <div style="height: 20px;"></div>
      <div class="preview-buttons">
        <button type="button" class="btn" onclick="confirmSubmit()">登録</button>
        <button type="button" class="btn btn-cancel" onclick="cancelSubmit()">キャンセル</button>
      </div>
    </div>

    <!-- 照会モード用セクション -->
    <div id="querySection" style="display:none;">
      <h2>照会・探索</h2>
      <!-- JANコード検索フォームを表形式に変更 -->
      <div style="margin: 20px 0;">
        <h2>探索JANコードテーブル</h2>
        <table id="janCodeTable" style="width: 100%; margin-bottom: 20px;">
          <thead>
            <tr>
              <th style="width: 10%;">探索対象</th>
              <th style="width: 40%;">JANコード</th>
              <th style="width: 20%;">アクション</th>
              <th style="width: 15%;">状態</th>
            </tr>
          </thead>
          <tbody id="janCodeBody">
            <!-- JANコード入力行のテンプレート -->
            <tr>
              <td>
                <input type="checkbox" class="jan-code-checkbox checkbox-large" checked onchange="updateJANCodeRowStyle(this)">
              </td>
              <td>a
                <input type="text" class="jan-code-input form-control" style="padding: 10px; font-size: 16px; width: 90%;" placeholder="JANコードを入力">
              </td>
              <td>
                <button type="button" class="btn btn-yellow" onclick="startCameraAnalysis('query', this)" aria-label="カメラでJANコードを読み取る">カメラで読取</button>
              </td>
              <td class="status-cell"></td>
            </tr>
          </tbody>
        </table>
        <div style="text-align: center; margin-bottom: 20px;">
          <button type="button" class="btn" onclick="addJANCodeRow()" aria-label="JANコード入力行を追加">＋ JANコード追加</button>
          <button type="button" class="btn" onclick="openSheetSelector()" aria-label="シートからJANコードをインポート">シートからJANコードインポート</button>
        </div>
      </div>
      <!-- カメラビュー用のコンテナ -->
      <div id="queryCameraContainer" style="display: none; margin: 20px 0;">
        <div id="query-status-bar" style="background: #4CAF50; color: white; padding: 8px; text-align: center; margin-bottom: 10px;">バーコードをかざしてください</div>
        <div id="query-result-area">
          <div id="query-latest-result" style="font-size: 24px; font-weight: bold; text-align: center; margin: 5px 0; font-family: monospace;"></div>
        </div>
        <div id="query-interactive" class="viewport" style="width: 100%; height: 300px; background: #000;"></div>
      </div>
      <!-- 照会モード用のRFIDテーブル -->
      <div style="margin: 20px 0;">
        <h2>登録済みRFIDリスト</h2>
        <table id="rfidTable" style="width: 100%;">
          <thead>
            <tr>
              <th style="width: 15%;">探索対象</th>
              <th style="width: 30%;">JANコード</th>
              <th style="width: 30%;">RFID ID</th>
              <th style="width: 10%;">発見</th>
              <th style="width: 15%;">発見回数</th>
            </tr>
          </thead>
          <tbody>
            <!-- RFIDリストがここに挿入されます -->
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- 登録完了メッセージのセクションを追加 -->
    <div id="successMessage">
      登録が完了しました。
    </div>

    <!-- 照会モードの成功メッセージ -->
    <div id="querySuccessMessage">
      照会が正常に完了しました。
    </div>

    <!-- 照会モードでRFIDが見つからなかった場合のメッセージ -->
    <div id="queryNotFoundMessage">
      入力されたRFIDはリストに存在しませんでした。
    </div>
    
    <!-- エラーメッセージのセクションを追加 -->
    <div id="errorMessage">
      エラーが発生しました。コンソールを確認してください。
    </div>

    <!-- シート選択モーダル -->
    <div id="sheetSelectorModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span class="close" onclick="closeSheetSelector()">&times;</span>
          <h3>シートを選択</h3>
        </div>
        <select id="sheetSelector" style="padding: 10px; font-size: 16px; width: 100%; margin-bottom: 20px;">
          <option value="">シートを選択してください</option>
        </select>
        <div class="modal-footer">
          <button type="button" class="btn btn-cancel" onclick="closeSheetSelector()">キャンセル</button>
          <button type="button" class="btn" onclick="importJANCodes()">インポート</button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <script>
      const RFID_LENGTH = 24; // RFID IDの固定長
      let allUniqueRFIDs = []; // 全体のユニークなRFID IDのリスト
      let fullRFIDList = []; // 照会モード用の全RFIDリスト

      // アプリケーションの状態を管理するオブジェクトを定義
      const appState = {
        isActiveMode: true,
        currentMode: 'query',
        focusInterval: null, // focusIntervalをここで初期化
        cameraMode: null,
        cameraTarget: null
      };

      // モード切替関数を修正して、照会モード時にRFIDリストを読み込むようにする
      function switchMode(mode) {
        appState.currentMode = mode;
        
        if (mode === 'registration') {
          // 登録モードの表示設定
          document.getElementById('registerSection').style.display = 'block';
          document.getElementById('querySection').style.display = 'none';
          
          // 登録モードではフォーカスを設定しない
          appState.isActiveMode = false;
          
          // フォーカス維持タイマーをクリア
          if (appState.focusInterval) {
            clearInterval(appState.focusInterval);
            appState.focusInterval = null;
          }
          
          // アクティブモードボタンの表示を更新
          const button = document.getElementById('activeMode');
          if (button) {
            button.classList.remove('btn-active-on');
            button.classList.add('btn-active-off');
            button.textContent = 'アクティブモード: OFF';
          }
          
        } else if (mode === 'query') {
          // 照会モードの表示設定
          document.getElementById('registerSection').style.display = 'none';
          document.getElementById('querySection').style.display = 'block';
          
          // 照会モードではアクティブモードを有効にする
          appState.isActiveMode = true;
          
          // アクティブモードボタンの表示を更新
          const button = document.getElementById('activeMode');
          if (button) {
            button.classList.remove('btn-active-off');
            button.classList.add('btn-active-on');
            button.textContent = 'アクティブモード: ON';
          }
          
          // RFIDリストを読み込む
          loadRFIDList();
          
          // 照会モードの場合のみフォーカスを設定
          setFocus();
        }
      }

      // 空のプレビューテーブルを初期化する関数
      function initializeEmptyPreviewTable() {
        const previewBody = document.getElementById("previewBody");
        previewBody.innerHTML = '';
        
        // 空の行を1つ追加
        addEmptyRowToPreviewTable();
      }

      // 空の行をプレビューテーブルに追加する関数
      function addEmptyRowToPreviewTable() {
        const previewBody = document.getElementById("previewBody");
        
        const row = document.createElement("tr");
        row.setAttribute("data-rfid", "");
        row.setAttribute("data-jan-code", "");

        // JANコードセル - 編集可能にする
        const janCodeCell = document.createElement("td");
        const janCodeInput = document.createElement("input");
        janCodeInput.type = "text";
        janCodeInput.value = "";
        janCodeInput.placeholder = "JANコードを入力";
        janCodeInput.className = "form-control jan-code-edit";
        janCodeInput.style.width = "100%";
        janCodeInput.style.padding = "5px";
        janCodeInput.style.fontSize = "16px";
        janCodeInput.addEventListener("change", function() {
          row.setAttribute("data-jan-code", this.value);
        });
        janCodeCell.appendChild(janCodeInput);
        row.appendChild(janCodeCell);

        // RFID IDセル - 空のテキスト入力
        const rfidCell = document.createElement("td");
        const rfidInput = document.createElement("input");
        rfidInput.type = "text";
        rfidInput.value = "";
        rfidInput.placeholder = "RFIDを入力またはスキャン";
        rfidInput.className = "form-control rfid-edit";
        rfidInput.style.width = "100%";
        rfidInput.style.padding = "5px";
        rfidInput.style.fontSize = "16px";
        rfidInput.addEventListener("change", function() {
          row.setAttribute("data-rfid", this.value);
        });
        rfidCell.appendChild(rfidInput);
        row.appendChild(rfidCell);
        
        previewBody.appendChild(row);
        
        // 入力にフォーカスを当てる
        janCodeInput.focus();
      }

      // テキストエリアへの入力イベントを監視（デバウンスを実装）
      let debounceTimeout;
      document.getElementById("rfidData").addEventListener("input", function() {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(handleInput, 500); // 500ms後に処理を実行
      });

      function handleInput() {
        const mode = document.getElementById('registerSection').style.display === 'block' ? 'registration' : 'query';
        if (mode === 'registration') {
          processNewRFIDs(); // 新しいRFIDを処理
        } else if (mode === 'query') {
          searchRFID();
        }
        document.getElementById("rfidData").value = "";
      }

      // 新しいRFIDを処理する関数
      function processNewRFIDs() {
        const data = document.getElementById("rfidData").value.trim();
        const dataLength = data.length;

        // RFIDの長さが不足している場合は終了
        if (dataLength < RFID_LENGTH) {
          return;
        }

        const rfidEntries = parseRFIDDataFixedLength(data, RFID_LENGTH);
        
        if (rfidEntries.length === 0) {
          return;
        }

        const previewBody = document.getElementById("previewBody");
        
        // 重複を排除するためのセット
        const uniqueRfids = new Set();
        rfidEntries.forEach(rfid => uniqueRfids.add(rfid));
        
        // 既存のRFIDを取得
        const existingRfids = new Set();
        const rows = previewBody.getElementsByTagName("tr");
        for (let row of rows) {
          const rfidValue = row.getAttribute("data-rfid");
          if (rfidValue) {
            existingRfids.add(rfidValue);
          }
        }
        
        // 新しいRFIDを追加
        for (const rfid of uniqueRfids) {
          // 既に表示済みのRFIDはスキップ
          if (existingRfids.has(rfid)) {
            continue;
          }
          
          // 空の行を探す
          let emptyRow = null;
          for (let row of rows) {
            const rfidValue = row.getAttribute("data-rfid");
            if (!rfidValue) {
              emptyRow = row;
              break;
            }
          }
          
          if (emptyRow) {
            // 空の行にRFIDを設定
            emptyRow.setAttribute("data-rfid", rfid);
            const rfidInput = emptyRow.querySelector(".rfid-edit");
            if (rfidInput) {
              rfidInput.value = rfid;
            }
          } else {
            // 空の行がない場合は新しい行を追加
            const row = document.createElement("tr");
            row.setAttribute("data-rfid", rfid);
            row.setAttribute("data-jan-code", "");

            // JANコードセル - 編集可能にする
            const janCodeCell = document.createElement("td");
            const janCodeInput = document.createElement("input");
            janCodeInput.type = "text";
            janCodeInput.value = "";
            janCodeInput.placeholder = "JANコードを入力";
            janCodeInput.className = "form-control jan-code-edit";
            janCodeInput.style.width = "100%";
            janCodeInput.style.padding = "5px";
            janCodeInput.style.fontSize = "16px";
            janCodeInput.addEventListener("change", function() {
              row.setAttribute("data-jan-code", this.value);
            });
            janCodeCell.appendChild(janCodeInput);
            row.appendChild(janCodeCell);

            // RFID IDセル
            const rfidCell = document.createElement("td");
            rfidCell.textContent = rfid;
            
            // 重複チェック
            if (allUniqueRFIDs.includes(rfid)) {
              rfidCell.classList.add("duplicate");
              rfidCell.textContent += " (重複)";
            } else {
              allUniqueRFIDs.push(rfid);
            }
            
            row.appendChild(rfidCell);
            previewBody.appendChild(row);
          }
          
          // 新しいRFIDが追加されたら、新しい空の行を追加
          addEmptyRowToPreviewTable();
        }
        
        // テキストエリアをクリア
        document.getElementById("rfidData").value = "";
      }

      // JANコード入力フィールドの変更イベントを監視
      document.getElementById("registerJanCode").addEventListener("input", function() {
        const janCode = this.value.trim();
        updatePreviewJANCode(janCode);
      });

      // 登録モードでのプレビュー表示関数を修正
      function showPreview() {
        // 登録完了メッセージを非表示にする
        document.getElementById("successMessage").style.display = "none";
        // 登録セクションを表示
        document.getElementById("registerSection").style.display = "block";

        const data = document.getElementById("rfidData").value.trim();
        const dataLength = data.length;

        // RFIDの長さが不足している場合は、プレビューテーブルをクリアして終了
        if (dataLength < RFID_LENGTH) {
          document.getElementById("previewBody").innerHTML = "";
          return;
        }

        const rfidEntries = parseRFIDDataFixedLength(data, RFID_LENGTH);
        
        if (rfidEntries.length === 0) {
          if (dataLength >= RFID_LENGTH) {
            console.log("有効なRFIDデータが見つかりませんでした");
          }
          document.getElementById("previewBody").innerHTML = "";
          return;
        }

        const previewBody = document.getElementById("previewBody");
        
        // 重複を排除するためのセット
        const uniqueRfids = new Set();

        rfidEntries.forEach(rfid => {
          // 既に表示済みのRFIDはスキップ
          if (uniqueRfids.has(rfid)) {
            return;
          }
          uniqueRfids.add(rfid);
          
          // 既存の行をチェック（同じRFIDの行が既にあるかどうか）
          const existingRow = document.querySelector(`tr[data-rfid="${rfid}"]`);
          if (existingRow) {
            return; // 既に表示されている場合はスキップ
          }
          
          const row = document.createElement("tr");
          row.setAttribute("data-rfid", rfid);
          row.setAttribute("data-jan-code", ""); // 初期値は空

          // JANコードセル - 編集可能にする
          const janCodeCell = document.createElement("td");
          const janCodeInput = document.createElement("input");
          janCodeInput.type = "text";
          janCodeInput.value = "";
          janCodeInput.placeholder = "JANコードを入力";
          janCodeInput.className = "form-control jan-code-edit";
          janCodeInput.style.width = "100%";
          janCodeInput.style.padding = "5px";
          janCodeInput.style.fontSize = "16px";
          janCodeInput.addEventListener("change", function() {
            row.setAttribute("data-jan-code", this.value);
          });
          janCodeCell.appendChild(janCodeInput);
          row.appendChild(janCodeCell);

          // RFID IDセル
          const rfidCell = document.createElement("td");
          rfidCell.textContent = rfid;
          
          // 重複チェック
          if (allUniqueRFIDs.includes(rfid)) {
            rfidCell.classList.add("duplicate");
            rfidCell.textContent += " (重複)";
          } else {
            allUniqueRFIDs.push(rfid);
          }
          
          row.appendChild(rfidCell);
          previewBody.appendChild(row);
        });
      }

      // プレビューテーブルのJANコードを更新する関数を修正
      function updatePreviewJANCode(janCode) {
        const previewBody = document.getElementById("previewBody");
        const rows = previewBody.getElementsByTagName("tr");
        for (let row of rows) {
          const janCodeInput = row.querySelector(".jan-code-edit");
          if (janCodeInput) {
            janCodeInput.value = janCode;
            row.setAttribute("data-jan-code", janCode);
          }
        }
      }

      // RFIDリストを読み込む関数を修正
      function loadRFIDList() {
        console.log('loadRFIDList: JAN-RFIDシートからデータを読み込みます');
        
        // ローディングインジケータを表示
        showLoadingIndicator();
        
        // サーバーサイド関数を呼び出してRFIDリストを取得
        google.script.run
          .withSuccessHandler(function(rfidList) {
            console.log('getRFIDListFromSheet success:', rfidList);
            
            // RFIDリストを表示
            displayRFIDList(rfidList);
            
            // ローディングインジケータを非表示
            hideLoadingIndicator();
          })
          .withFailureHandler(function(error) {
            console.error('getRFIDListFromSheet error:', error);
            alert('RFIDリストの取得に失敗しました: ' + error);
            
            // ローディングインジケータを非表示
            hideLoadingIndicator();
          })
          .getRFIDListFromSheet('JAN-RFID');
      }

      // RFIDリストを表示する関数を修正
      function displayRFIDList(rfidList) {
        console.log('displayRFIDList 関数が呼び出されました。');
        console.log('Received rfidList:', rfidList);
        
        // テーブル要素を取得
        const table = document.getElementById('rfidTable');
        if (!table) {
          console.error('rfidTable 要素が見つかりません');
          return;
        }
        
        // テーブルのボディ部分を取得または作成
        let tbody = table.querySelector('tbody');
        if (!tbody) {
          tbody = document.createElement('tbody');
          table.appendChild(tbody);
        } else {
          // 既存の内容をクリア
          tbody.innerHTML = '';
        }
        
        // データがない場合
        if (!rfidList || rfidList.length === 0) {
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.colSpan = 5; // 列数に合わせて調整
          cell.textContent = 'データがありません';
          cell.style.textAlign = 'center';
          cell.style.padding = '20px';
          row.appendChild(cell);
          tbody.appendChild(row);
          
          console.log('データがないため、空のメッセージを表示しました');
          return;
        }
        
        // 各RFIDデータに対して行を作成
        rfidList.forEach(function(item, index) {
          const row = document.createElement('tr');
          row.setAttribute('data-jan-code', item.janCode);
          row.setAttribute('data-rfid', item.rfid);
          
          // チェックボックスセル
          const checkboxCell = document.createElement('td');
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.className = 'rfid-checkbox';
          checkboxCell.appendChild(checkbox);
          row.appendChild(checkboxCell);
          
          // JANコードセル
          const janCodeCell = document.createElement('td');
          janCodeCell.textContent = item.janCode;
          row.appendChild(janCodeCell);
          
          // RFIDセル
          const rfidCell = document.createElement('td');
          rfidCell.textContent = item.rfid;
          row.appendChild(rfidCell);
          
          // 発見セル
          const discoveryCell = document.createElement('td');
          const discoveryCheckbox = document.createElement('input');
          discoveryCheckbox.type = 'checkbox';
          discoveryCheckbox.className = 'discovery-checkbox';
          discoveryCheckbox.disabled = true; // 編集不可
          discoveryCell.appendChild(discoveryCheckbox);
          row.appendChild(discoveryCell);
          
          // 発見回数セル
          const countCell = document.createElement('td');
          countCell.textContent = '0';
          countCell.className = 'discovery-count';
          row.appendChild(countCell);
          
          // 行をテーブルに追加
          tbody.appendChild(row);
        });
        
        console.log('照会リストが表示されました。');
      }

      // ローディングインジケータを表示する関数
      function showLoadingIndicator() {
        // ローディングインジケータ要素を取得または作成
        let loadingIndicator = document.getElementById('loadingIndicator');
        
        if (!loadingIndicator) {
          loadingIndicator = document.createElement('div');
          loadingIndicator.id = 'loadingIndicator';
          loadingIndicator.style.position = 'fixed';
          loadingIndicator.style.top = '0';
          loadingIndicator.style.left = '0';
          loadingIndicator.style.width = '100%';
          loadingIndicator.style.height = '100%';
          loadingIndicator.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
          loadingIndicator.style.display = 'flex';
          loadingIndicator.style.justifyContent = 'center';
          loadingIndicator.style.alignItems = 'center';
          loadingIndicator.style.zIndex = '9999';
          
          const spinner = document.createElement('div');
          spinner.className = 'spinner';
          spinner.style.width = '50px';
          spinner.style.height = '50px';
          spinner.style.border = '5px solid #f3f3f3';
          spinner.style.borderTop = '5px solid #3498db';
          spinner.style.borderRadius = '50%';
          spinner.style.animation = 'spin 1s linear infinite';
          
          loadingIndicator.appendChild(spinner);
          document.body.appendChild(loadingIndicator);
          
          // スピナーアニメーションのスタイルを追加
          const style = document.createElement('style');
          style.textContent = `
            @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
            }
          `;
          document.head.appendChild(style);
        }
        
        loadingIndicator.style.display = 'flex';
      }

      // ローディングインジケータを非表示にする関数
      function hideLoadingIndicator() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        if (loadingIndicator) {
          loadingIndicator.style.display = 'none';
        }
      }

      // RFIDを削除する関数
      function deleteRFID(janCode, rfid) {
        // ローディングインジケータを表示
        showLoadingIndicator();
        
        // サーバーサイド関数を呼び出してRFIDを削除
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              alert('RFIDが正常に削除されました。');
              // リストを再読み込み
              loadRFIDList();
            } else {
              alert('RFIDの削除に失敗しました: ' + result.message);
              hideLoadingIndicator();
            }
          })
          .withFailureHandler(function(error) {
            console.error('deleteRFID error:', error);
            alert('RFIDの削除に失敗しました: ' + error);
            hideLoadingIndicator();
          })
          .deleteRFIDFromSheet('JAN-RFID', janCode, rfid);
      }

      // 照会モードでデータ取得失敗時のエラーハンドリング関数
      function handleLoadRFIDListError(error) {
        console.error('RFIDリストの取得に失敗しました:', error);
        document.getElementById('errorMessage').style.display = 'block';
      }

      // 照会モードでのRFID検索関数を修正
      function searchRFID() {
        const data = document.getElementById("rfidData").value.trim().toUpperCase();
        const queryRFIDs = parseRFIDDataFixedLength(data, RFID_LENGTH);

        if (queryRFIDs.length === 0) {
          alert("有効なRFIDデータが見つかりませんでした。");
          document.getElementById("rfidData").value = "";
          return;
        }

        // デバッグログを追加
        console.log('検索するRFID:', queryRFIDs);

        const selectedCheckboxes = document.querySelectorAll('#rfidTable input.rfid-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
          alert("照合するRFIDを選択してください。");
          document.getElementById("rfidData").value = "";
          return;
        }

        // 選択されているJANコードを取得
        const selectedJANCodes = Array.from(document.querySelectorAll('#janCodeBody tr'))
          .filter(row => row.querySelector('.jan-code-checkbox:checked'))
          .map(row => row.querySelector('.jan-code-input').value.trim())
          .filter(code => code !== '');

        console.log('選択されているJANコード:', selectedJANCodes);

        if (selectedJANCodes.length === 0) {
          alert("探索するJANコードを選択してください。");
          document.getElementById("rfidData").value = "";
          return;
        }

        const selectedRFIDs = Array.from(selectedCheckboxes).map(cb => {
          const row = cb.closest('tr');
          return row.getAttribute('data-rfid') ? row.getAttribute('data-rfid').toUpperCase() : '';
        }).filter(rfid => rfid !== '');

        console.log('選択されているRFID:', selectedRFIDs);

        let foundAny = false;
        let notFoundRFIDs = [];
        let uniqueFoundRFIDs = new Set();
        let foundJANCodes = new Map(); // JANコードとタイムスタンプのマップ

        const currentTimestamp = new Date().toLocaleString('ja-JP');

        queryRFIDs.forEach(queryRFID => {
          console.log('検索中のRFID:', queryRFID);
          
          if (selectedRFIDs.includes(queryRFID)) {
            let found = false;
            const rows = document.querySelectorAll('#rfidTable tbody tr');
            
            for (let i = 0; i < rows.length; i++) {
              const row = rows[i];
              const rowRFID = row.getAttribute('data-rfid');
              const rowJANCode = row.getAttribute('data-jan-code');
              
              if (!rowRFID || !rowJANCode) {
                console.log('行にデータ属性がありません:', i);
                continue;
              }
              
              // JANコードが選択されているものに含まれているかチェック
              if (!selectedJANCodes.includes(rowJANCode)) {
                continue;
              }
              
              // デバッグログを追加
              console.log('比較:', {
                '入力RFID': queryRFID,
                'テーブルのRFID': rowRFID.toUpperCase(),
                '一致': rowRFID.toUpperCase() === queryRFID
              });
              
              if (rowRFID.toUpperCase() === queryRFID) {
                // 発見チェックボックスをチェック
                const foundCheckbox = row.querySelector('.discovery-checkbox');
                if (foundCheckbox) foundCheckbox.checked = true;
                
                // 発見回数を更新 - ここを修正
                const countCell = row.querySelector('.discovery-count');
                if (countCell) {
                  // 現在の回数を取得して増加
                  const currentCount = parseInt(countCell.textContent) || 0;
                  const newCount = currentCount + 1;
                  countCell.textContent = newCount.toString();
                  console.log(`発見回数を更新: ${currentCount} → ${newCount}`);
                } else {
                  // 発見回数セルがない場合は5番目のセルを取得
                  const cells = row.querySelectorAll('td');
                  if (cells.length >= 5) {
                    const fifthCell = cells[4]; // インデックスは0から始まるので5番目は[4]
                    const currentCount = parseInt(fifthCell.textContent) || 0;
                    const newCount = currentCount + 1;
                    fifthCell.textContent = newCount.toString();
                    console.log(`発見回数を更新 (5番目のセル): ${currentCount} → ${newCount}`);
                  }
                }
                
                // JANコードを記録（タイムスタンプ付き）
                if (rowJANCode) {
                  foundJANCodes.set(rowJANCode, currentTimestamp);
                }
                
                // 該当行をハイライト
                row.style.backgroundColor = '#e6ffe6';
                setTimeout(() => {
                  row.style.backgroundColor = '';
                }, 2000); // 2秒後にハイライトを解除
                
                found = true;
                foundAny = true;
                uniqueFoundRFIDs.add(queryRFID);
                break;
              }
            }
            
            if (!found) {
              notFoundRFIDs.push(queryRFID);
            }
          } else {
            notFoundRFIDs.push(queryRFID);
          }
        });

        // JANコードの状態フィールドを更新
        updateJANCodeStatusFields(foundJANCodes);

        // 見つかったユニークなRFIDが1つ以上ある場合のみbeepを1回実行
        if (uniqueFoundRFIDs.size > 0) {
          Promise.resolve().then(() => {
            try {
              beep();
            } catch (error) {
              console.error('Beep error:', error);
            }
          });
        }

        if (foundAny) {
          showQuerySuccessMessage();
        }

        if (notFoundRFIDs.length > 0) {
          showQueryNotFoundMessage(notFoundRFIDs);
        }

        // テキストエリアをクリア
        document.getElementById("rfidData").value = "";
        
        // アクティブモードの場合、フォーカスを戻す
        if (appState.isActiveMode) {
          setTimeout(() => setFocus(), 10);
        }
      }

      // 探索JANコードテーブルの状態フィールドを更新する関数
      function updateJANCodeStatusFields(foundJANCodes) {
        const janCodeRows = document.querySelectorAll('#janCodeBody tr');
        
        janCodeRows.forEach(row => {
          const janCodeInput = row.querySelector('.jan-code-input');
          if (!janCodeInput) return;
          
          const janCode = janCodeInput.value.trim();
          const statusCell = row.querySelector('.status-cell');
          
          if (!statusCell) return;
          
          if (foundJANCodes.has(janCode)) {
            // スキャン状態とタイムスタンプを表示
            const timestamp = foundJANCodes.get(janCode);
            statusCell.innerHTML = `<span style="color: #006400; font-weight: bold;">スキャン</span><br><span style="font-size: 0.8em;">${timestamp}</span>`;
            statusCell.style.backgroundColor = '#e6ffe6';
            statusCell.style.textAlign = 'center';
            statusCell.style.padding = '5px';
          }
        });
      }

      // 新しいJANコード行を追加する関数
      function addJANCodeRow() {
        const tbody = document.getElementById('janCodeBody');
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
          <td>
            <input type="checkbox" class="jan-code-checkbox checkbox-large" checked onchange="updateJANCodeRowStyle(this)">
          </td>
          <td>
            <input type="text" class="jan-code-input form-control" style="padding: 10px; font-size: 16px; width: 90%;" placeholder="JANコードを入力">
          </td>
          <td>
            <button type="button" class="btn btn-yellow" onclick="startCameraAnalysis('query', this)" aria-label="カメラでJANコードを読み取る">カメラで読取</button>
          </td>
          <td class="status-cell"></td>
        `;
        tbody.appendChild(newRow);
      }

      // シートからJANコードをインポートする関数
      function importJANCodesFromSheet(sheetName) {
        const sheetToUse = sheetName || "探索票"; // デフォルトのシート名
        console.log(`Importing JAN codes from sheet: ${sheetToUse}`);
        
        // シートからJANコードを取得
        google.script.run
          .withSuccessHandler(function(janCodes) {
            console.log("Received JAN codes:", janCodes);
            
            if (!janCodes || janCodes.length === 0) {
              alert("シートにJANコードが見つかりませんでした。");
              return;
            }
            
            // 既存のJANコード入力行をクリア
            const tbody = document.getElementById('janCodeBody');
            tbody.innerHTML = '';
            
            // 各JANコードに対して新しい行を追加
            janCodes.forEach(janCode => {
              if (!janCode) return; // 空のJANコードをスキップ
              
              const trimmedJanCode = String(janCode).trim();
              if (!trimmedJanCode) return;
              
              console.log(`Adding row for JAN code: ${trimmedJanCode}`);
              
              const newRow = document.createElement('tr');
              newRow.innerHTML = `
                <td>
                  <input type="checkbox" class="jan-code-checkbox checkbox-large" checked onchange="updateJANCodeRowStyle(this)">
                </td>
                <td>
                  <input type="text" class="jan-code-input form-control" style="padding: 10px; font-size: 16px; width: 90%;" value="${trimmedJanCode}" readonly>
                </td>
                <td>
                  <button type="button" class="btn btn-yellow" onclick="startCameraAnalysis('query', this)" aria-label="カメラでJANコードを読み取る">カメラで読取</button>
                </td>
                <td class="status-cell"></td>
              `;
              tbody.appendChild(newRow);
            });

            // インポートされた全てのJANコードに対してRFIDの選択状態を更新
            const checkboxes = document.querySelectorAll('.jan-code-checkbox');
            checkboxes.forEach(checkbox => {
              updateRFIDSelectionsByJANCode(checkbox);
            });

            // 対応するRFID行をハイライト
            highlightMatchingRFIDRows();

            // 成功メッセージを表示
            alert(`${janCodes.length}件のJANコードをインポートしました。`);
          })
          .withFailureHandler(function(error) {
            console.error('JANコードのインポートに失敗しました:', error);
            alert('JANコードのインポートに失敗しました: ' + error);
          })
          .importJANCodesFromSheet(sheetToUse);
      }

      // JANコードの状態を更新する関数
      function updateJANCodeStatuses() {
        // 照会モードの場合のみ処理
        if (document.getElementById('querySection').style.display !== 'block') {
          return;
        }
        
        const rfidTable = document.getElementById("rfidTable");
        const tbody = rfidTable.getElementsByTagName("tbody")[0];
        const rows = tbody.getElementsByTagName("tr");
        
        // 見つかったJANコードのセット
        const foundJANCodes = new Set();
        
        // JANコード入力欄から選択されているJANコードを取得
        const janCodeInputs = document.querySelectorAll('.jan-code-input');
        janCodeInputs.forEach(input => {
          const checkbox = input.closest('tr').querySelector('.jan-code-checkbox');
          if (checkbox && checkbox.checked) {
            foundJANCodes.add(input.value.trim());
          }
        });
        
        console.log("更新: 選択されたJANコード:", Array.from(foundJANCodes));
        
        // 各行をチェック
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          const janCode = row.getAttribute("data-jan-code");
          
          if (!janCode) continue;
          
          const selectCheckbox = row.querySelector(".rfid-checkbox");
          
          // JANコードが見つかったリストに含まれている場合
          if (foundJANCodes.has(janCode)) {
            console.log(`JANコード ${janCode} が選択リストに含まれています。選択します。`);
            
            // 選択チェックボックスをチェック
            if (selectCheckbox) {
              selectCheckbox.checked = true;
              console.log(`JANコード ${janCode} のチェックボックスを選択しました。`);
            }
          } else {
            // 選択チェックボックスのチェックを外す
            if (selectCheckbox) selectCheckbox.checked = false;
          }
        }
      }

      // 対応するRFID行を一時的にハイライトする関数
      function highlightMatchingRFIDRows() {
        // 選択されているJANコードを取得
        const selectedJANCodes = new Set();
        const janCodeInputs = document.querySelectorAll('.jan-code-input');
        janCodeInputs.forEach(input => {
          const checkbox = input.closest('tr').querySelector('.jan-code-checkbox');
          if (checkbox && checkbox.checked) {
            selectedJANCodes.add(input.value.trim());
          }
        });
        
        console.log("ハイライト: 選択されたJANコード:", Array.from(selectedJANCodes));
        
        // RFIDテーブルの行を取得
        const rfidTable = document.getElementById("rfidTable");
        const tbody = rfidTable.getElementsByTagName("tbody")[0];
        const rows = tbody.getElementsByTagName("tr");
        
        // マッチする行をハイライト
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          const janCode = row.getAttribute("data-jan-code");
          
          if (!janCode) continue;
          
          if (selectedJANCodes.has(janCode)) {
            console.log(`JANコード ${janCode} の行をハイライトします。`);
            
            // 行の背景色を緑色に変更
            row.style.transition = "background-color 0.5s";
            row.style.backgroundColor = '#e6ffe6';
            
            // 3秒後に背景色を元に戻す
            setTimeout(() => {
              row.style.backgroundColor = '';
            }, 3000);
          }
        }
      }

      // RFIDデータを固定長で解析する関数を修正
      function parseRFIDDataFixedLength(data, length) {
        const rfidList = [];
        // 改行で分割して処理
        const lines = data.split(/\r?\n/);
        
        lines.forEach(line => {
          const trimmedLine = line.trim();
          // 各行が有効なRFIDかチェック
          if (trimmedLine.length === length && /^[A-Z0-9]+$/i.test(trimmedLine)) {
            rfidList.push(trimmedLine);
          }
        });
        
        return rfidList;
      }

      // 登録モードでの登録関数を修正
      function confirmSubmit() {
        const previewBody = document.getElementById("previewBody");
        const rows = previewBody.getElementsByTagName("tr");
        
        if (rows.length === 0) {
          alert("登録するデータがありません。");
          return;
        }
                
        const entries = [];
        
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          const janCodeValue = row.getAttribute("data-jan-code") || "";
          const rfidValue = row.getAttribute("data-rfid") || "";
          
          if (!rfidValue) {
            continue; // RFID値がない行はスキップ
          }
          
          const entry = {
            janCode: janCodeValue,
            rfid: rfidValue
          };
          
          entries.push(entry);
        }
        
        if (entries.length === 0) {
          alert("送信する有効なデータがありません。");
          return;
        }
        
        // デバッグログ
        console.log('Sending entries:', entries);
        console.log('First entry:', entries[0]);
        console.log('RFID value:', entries[0].rfid);
        
        // データ送信とハンドリング - スプレッドシート名を指定
        google.script.run
          .withSuccessHandler(function(response) {
            console.log('Success response:', response);
            document.getElementById("registerSection").style.display = "none";
            document.getElementById("previewBody").innerHTML = "";
            document.getElementById("registerJanCode").value = "";
            document.getElementById("successMessage").style.display = "block";
            document.getElementById("myForm").reset();
            document.getElementById("rfidData").focus();
          })
          .withFailureHandler(function(error) {
            console.error('Error:', error);
            alert("エラーが発生しました: " + error.message);
          })
          .processFormToSheet({ rfidData: entries, sheetName: "JAN-RFID" });
      }

      // 登録モードでのキャンセル関数
      function cancelSubmit() {
        // プレビューセクションを非表示
        document.getElementById("registerSection").style.display = "none";
        // プレビューテーブルの内容をクリア
        document.getElementById("previewBody").innerHTML = "";
        // 全体のRFIDリストをクリア
        allUniqueRFIDs = [];
        // テキストエリアにフォーカスを設定
        document.getElementById("rfidData").focus();
      }

      // クリアボタン関数を修正
      function clearInput() {
        const mode = document.getElementById('registerSection').style.display === 'block' ? 'registration' : 'query';

        // テキストエリアをクリア
        document.getElementById("rfidData").value = "";

        if (mode === 'registration') {
          // プレビューテーブルの内容をクリア
          document.getElementById("previewBody").innerHTML = "";
          // 登録完了メッセージを非表示
          document.getElementById("successMessage").style.display = "none";
          // 全体のRFIDリストをクリア
          allUniqueRFIDs = [];
          // 登録セクションを表示状態に保つ
          document.getElementById("registerSection").style.display = "block";
        }

        // 照会モードの場合、メッセージを非表示
        if (mode === 'query') {
          document.getElementById('querySuccessMessage').style.display = 'none';
          document.getElementById('queryNotFoundMessage').style.display = 'none';
          document.getElementById('errorMessage').style.display = 'none';
        }

        // テキストエリアにフォーカスを設定
        document.getElementById("rfidData").focus();
      }

      // 照会モードで選択したRFIDを削除する関数
      function deleteSelectedRFIDs() {
        const checkboxes = document.querySelectorAll('#rfidTable input[type="checkbox"]:checked');
        if (checkboxes.length === 0) {
          alert('削除するRFIDを選択してください。');
          return;
        }

        const selectedRFIDs = Array.from(checkboxes).map(cb => cb.value);

        // 削除の確認アラートを追加
        if (!confirm(`選択したRFIDを削除してもよろしいですか？\n${selectedRFIDs.join(', ')}`)) {
          return;
        }

        google.script.run.withSuccessHandler(() => {
          // 削除後にRFIDリストを再読み込み
          loadRFIDList();
          // 削除完了メッセージを表示
          document.getElementById('deleteSuccessMessage').style.display = 'block';
          // メッセージを数秒後に非表示
          setTimeout(() => {
            document.getElementById('deleteSuccessMessage').style.display = 'none';
          }, 3000);
        }).withFailureHandler((error) => {
          alert('エラーが発生しました: ' + error.message);
        }).deleteRFIDs(selectedRFIDs);
      }

      // ページ読み込み時の処理を更新
      window.onload = function() {
        switchMode('registration');
        
        // シート名のリストを取得
        google.script.run
          .withSuccessHandler(function(sheetNames) {
            const selector = document.getElementById('sheetSelector');
            sheetNames.forEach(name => {
              const option = document.createElement('option');
              option.value = name;
              option.textContent = name;
              selector.appendChild(option);
            });
          })
          .withFailureHandler(function(error) {
            console.error('シート名の取得に失敗しました:', error);
          })
          .getAllSheetNames();
        
        // 初期状態（アクティブモードON）の設定
        appState.isActiveMode = true;
        const button = document.getElementById('activeMode');
        button.classList.add('btn-active-on');
        button.textContent = 'アクティブモード: ON';
        
        const textarea = document.getElementById("rfidData");
        
        // blur イベントリスナーを設定
        textarea.addEventListener('blur', handleBlur);
        
        // フォーカスアウト時の再フォーカス
        textarea.addEventListener('focusout', function(e) {
          if (appState.isActiveMode) {
            e.preventDefault(); // デフォルト動作を防止
            setTimeout(() => setFocus(), 10);
          }
        });
        
        // クリック時にフォーカスが外れないようにする
        document.addEventListener('click', function(e) {
          if (appState.isActiveMode && e.target !== textarea) {
            setTimeout(() => setFocus(), 10);
          }
        });
        
        // タッチ時にフォーカスが外れないようにする（モバイル対応）
        document.addEventListener('touchstart', function(e) {
          if (appState.isActiveMode && e.target !== textarea) {
            setTimeout(() => setFocus(), 10);
          }
        });
        
        // 初期フォーカスを設定
        setFocus();
      };

      /**
       * 照会モードでRFIDリストが正常に表示された際のメッセージ表示関数
       */
      function showQuerySuccessMessage() {
        const existingMessage = document.getElementById('querySuccessMessage');
        const existingNotFoundMessage = document.getElementById('queryNotFoundMessage');
        const existingErrorMessage = document.getElementById('errorMessage');

        // 既存のメッセージを非表示にする
        if (existingMessage) existingMessage.style.display = 'none';
        if (existingNotFoundMessage) existingNotFoundMessage.style.display = 'none';
        if (existingErrorMessage) existingErrorMessage.style.display = 'none';

        // メッセージを表示
        document.getElementById('querySuccessMessage').style.display = 'block';

        // 3秒後にメッセージを非表示にする
        setTimeout(() => {
          document.getElementById('querySuccessMessage').style.display = 'none';
        }, 3000);
      }

      /**
       * 照会モードでRFIDが見つからなかった場合のメッセージ表示関数
       */
      function showQueryNotFoundMessage(notFoundRFIDs) {
        const existingMessage = document.getElementById('queryNotFoundMessage');
        const existingSuccessMessage = document.getElementById('querySuccessMessage');
        const existingErrorMessage = document.getElementById('errorMessage');

        // 既存のメッセージを非表示にする
        if (existingMessage) existingMessage.style.display = 'none';
        if (existingNotFoundMessage) existingNotFoundMessage.style.display = 'none';
        if (existingErrorMessage) existingErrorMessage.style.display = 'none';

        // メッセージ内容を更新
        document.getElementById('queryNotFoundMessage').textContent = `以下のRFIDはリストに存在しませんでした:\n${notFoundRFIDs.join(', ')}`;

        // メッセージを表示
        document.getElementById('queryNotFoundMessage').style.display = 'block';

        // 5秒後にメッセージを非表示にする
        setTimeout(() => {
          document.getElementById('queryNotFoundMessage').style.display = 'none';
        }, 5000);
      }

      // 非公式な方法でGoogleブランディングを非表示にするスクリプト
      document.addEventListener("DOMContentLoaded", function() {
        // 実際のIDやクラス名に置き換えてください
        var brandingElement = document.querySelector('#google-branding'); // 例: id が 'google-branding' の要素
        if (brandingElement) {
          brandingElement.style.display = 'none';
          // または、完全に削除
          // brandingElement.parentNode.removeChild(brandingElement);
        }
      });

      // beep関数を改善
      function beep() {
        return new Promise((resolve, reject) => {
          try {
            const context = new AudioContext();
            const gainNode = context.createGain();
            gainNode.connect(context.destination);
            gainNode.gain.value = 1.0; // 音量を控えめに

            // 見つかった時の楽しい音を作成
            const notes = [
              { frequency: 1047, duration: 100 }, // ド
              { frequency: 1319, duration: 100 }  // ミ
            ];

            let startTime = context.currentTime;
            notes.forEach((note, index) => {
              const oscillator = context.createOscillator();
              oscillator.type = "sine";
              oscillator.frequency.value = note.frequency;
              oscillator.connect(gainNode);
              
              oscillator.start(startTime);
              oscillator.stop(startTime + note.duration / 1000);
              startTime += note.duration / 1000;
              
              // 最後の音が終わったら解決
              if (index === notes.length - 1) {
                setTimeout(() => {
                  resolve();
                }, startTime * 1000);
              }
            });

          } catch (error) {
            console.error('Beep creation failed:', error);
            reject(error);
          }
        });
      }

      // フォーカスを設定する関数を強化
      function setFocus() {
        // 現在のモードが登録モードの場合はフォーカスを設定しない
        if (document.getElementById("registerSection").style.display === "block") {
          return;
        }
        
        // 照会モードの場合のみフォーカスを設定
        const rfidData = document.getElementById("rfidData");
        if (rfidData && appState.isActiveMode) {
          console.log('RFIDデータ入力欄にフォーカスを設定します');
          rfidData.focus();
        }
      }

      // blur イベントのハンドラー関数を強化
      function handleBlur(e) {
        if (appState.isActiveMode) {
          const textarea = document.getElementById("rfidData");
          // 即時フォーカスを戻す
          setTimeout(() => {
            if (appState.isActiveMode && document.activeElement !== textarea) {
              console.log('blur イベント後にフォーカスを再設定します');
              textarea.focus();
            }
          }, 10);
          
          // イベントのデフォルト動作を防止
          if (e) {
            e.preventDefault();
          }
        }
      }

      // アクティブモードを切り替える関数を修正
      function toggleActiveMode() {
        appState.isActiveMode = !appState.isActiveMode;
        const button = document.getElementById('activeMode');
        button.textContent = `アクティブモード: ${appState.isActiveMode ? 'ON' : 'OFF'}`;
        
        // ボタンのスタイルを切り替え
        if (appState.isActiveMode) {
          button.classList.remove('btn-active-off');
          button.classList.add('btn-active-on');
          setFocus(); // フォーカスを設定
        } else {
          button.classList.remove('btn-active-on');
          button.classList.add('btn-active-off');
          document.getElementById("rfidData").blur(); // フォーカスを外す
        }
      }

      // JANコードによる検索機能を複数JANコード対応に修正
      function searchAndCheckByMultipleJAN() {
        const janCodeRows = document.querySelectorAll('#janCodeBody tr');
        const selectedJANCodes = Array.from(janCodeRows)
          .filter(row => row.querySelector('.jan-code-checkbox').checked)
          .map(row => row.querySelector('.jan-code-input').value.trim())
          .filter(code => code !== '');

        if (selectedJANCodes.length === 0) {
          alert('検索するJANコードを選択して入力してください。');
          return;
        }

        // デバッグログを追加
        console.log('検索するJANコード:', selectedJANCodes);

        // まず全てのチェックボックスを解除
        const checkboxes = document.querySelectorAll('#rfidTable input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);

        // 各JANコードに一致するレコードを探してチェック
        let found = false;
        const rows = document.getElementById('rfidTable').getElementsByTagName('tr');

        selectedJANCodes.forEach((janCode) => {
          for (let i = 0; i < rows.length; i++) {
            const janCodeCell = rows[i].getElementsByTagName('td')[1]; // JANコードは2番目のセル（インデックス1）に変更
            const checkbox = rows[i].querySelector('input[type="checkbox"]');
            
            // デバッグログを追加
            console.log('比較:', {
              'Input JAN': janCode,
              'Table JAN': janCodeCell.textContent.trim(),
              'Equal?': janCodeCell.textContent.trim() === janCode
            });
            
            if (janCodeCell.textContent.trim() === janCode) {
              checkbox.checked = true;
              found = true;
              // 該当行をハイライト
              rows[i].style.backgroundColor = '#e6ffe6';
              setTimeout(() => {
                rows[i].style.backgroundColor = '';
              }, 2000); // 2秒後にハイライトを解除
            }
          }
        });

        if (!found) {
          alert('指定されたJANコードに一致するRFIDが見つかりませんでした。');
        } else {
          // 成功メッセージを表示
          showQuerySuccessMessage();
        }
      }

      // JANコード行のスタイルを更新する関数
      function updateJANCodeRowStyle(checkbox) {
        const row = checkbox.closest('tr');
        if (checkbox.checked) {
          // チェックが付いている場合は白色
          row.style.backgroundColor = '';
        } else {
          // チェックが外れている場合は灰色
          row.style.backgroundColor = '#f0f0f0';
        }
        
        // RFIDの選択状態も更新
        updateRFIDSelectionsByJANCode(checkbox);
      }

      // シート選択モーダルを開く関数
      function openSheetSelector() {
        const modal = document.getElementById('sheetSelectorModal');
        if (modal) {
          modal.style.display = 'block';
          
          // シート名のリストを再取得
          google.script.run
            .withSuccessHandler(function(sheetNames) {
              const selector = document.getElementById('sheetSelector');
              // 既存のオプションをクリア
              selector.innerHTML = '<option value="">シートを選択してください</option>';
              // 新しいシート名を追加
              sheetNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                selector.appendChild(option);
              });
            })
            .withFailureHandler(function(error) {
              console.error('シート名の取得に失敗しました:', error);
              alert('シート名の取得に失敗しました: ' + error);
              closeSheetSelector();
            })
            .getAllSheetNames();
        }
      }

      // シート選択モーダルを閉じる関数
      function closeSheetSelector() {
        const modal = document.getElementById('sheetSelectorModal');
        if (modal) {
          modal.style.display = 'none';
        }
      }

      // モーダルの外側をクリックした時に閉じる
      window.onclick = function(event) {
        const modal = document.getElementById('sheetSelectorModal');
        if (event.target == modal) {
          closeSheetSelector();
        }
      }

      // importJANCodes関数を修正
      function importJANCodes() {
        const sheetName = document.getElementById('sheetSelector').value;
        if (!sheetName) {
          alert('シートを選択してください。');
          return;
        }

        // デバッグログを追加
        console.log('Importing JAN codes from sheet:', sheetName);

        google.script.run
          .withSuccessHandler(function(janCodes) {
            // デバッグログを追加
            console.log('Received JAN codes:', janCodes);
            
            // JANコードのインポートが成功したらモーダルを閉じる
            closeSheetSelector();
            
            // 既存のJANコード入力行をクリア
            const tbody = document.getElementById('janCodeBody');
            tbody.innerHTML = '';

            // 各JANコードに対して新しい行を追加
            janCodes.forEach(janCode => {
              if (!janCode) return; // 空のJANコードをスキップ
              
              // デバッグログを追加
              console.log('Adding row for JAN code:', janCode);
              
              const newRow = document.createElement('tr');
              newRow.innerHTML = `
                <td>
                  <input type="checkbox" class="jan-code-checkbox checkbox-large" checked onchange="updateJANCodeRowStyle(this)">
                </td>
                <td>
                  <input type="text" class="jan-code-input form-control" style="padding: 10px; font-size: 16px; width: 90%;" value="${janCode}" readonly>
                </td>
                <td>
                  <button type="button" class="btn btn-yellow" onclick="startCameraAnalysis('query', this)" aria-label="カメラでJANコードを読み取る">カメラで読取</button>
                </td>
                <td class="status-cell"></td>
              `;
              tbody.appendChild(newRow);
            });

            // インポートされた全てのJANコードに対してRFIDの選択状態を更新
            const checkboxes = document.querySelectorAll('.jan-code-checkbox');
            checkboxes.forEach(checkbox => {
              updateRFIDSelectionsByJANCode(checkbox);
            });

            // JANコードの状態を更新（既に見つかっているものをマーク）
            updateJANCodeStatuses();

            // 成功メッセージを表示
            alert(`${janCodes.length}件のJANコードをインポートしました。`);
          })
          .withFailureHandler(function(error) {
            console.error('JANコードのインポートに失敗しました:', error);
            alert('JANコードのインポートに失敗しました: ' + error);
            closeSheetSelector();
          })
          .importJANCodesFromSheet(sheetName);
      }


      /**
       * Process form data and save to specified sheet
       * @param {Object} data - Form data containing rfidData array and sheetName
       * @return {Object} Response object
       */
      function processFormToSheet(data) {
        try {
          const ss = SpreadsheetApp.getActiveSpreadsheet();
          let sheet = ss.getSheetByName(data.sheetName);
          
          // Create sheet if it doesn't exist
          if (!sheet) {
            sheet = ss.insertSheet(data.sheetName);
            // Add headers
            sheet.appendRow(["JANコード", "RFID ID", "登録日時"]);
          }
          
          const entries = data.rfidData;
          const timestamp = new Date();
          
          // Add each entry to the sheet
          entries.forEach(entry => {
            sheet.appendRow([
              entry.janCode,
              entry.rfid,
              timestamp
            ]);
          });
          
          return { success: true, message: `${entries.length}件のデータが正常に登録されました。` };
        } catch (error) {
          console.error('Error in processFormToSheet:', error);
          return { success: false, message: error.toString() };
        }
      }

      /**
       * Get RFID list from specified sheet
       * @param {string} sheetName - Name of the sheet to get data from
       * @return {Array} Array of RFID objects
       */
      function getRFIDListFromSheet(sheetName) {
        try {
          const ss = SpreadsheetApp.getActiveSpreadsheet();
          const sheet = ss.getSheetByName(sheetName);
          
          if (!sheet) {
            return [];
          }
          
          const data = sheet.getDataRange().getValues();
          const headers = data[0];
          const janCodeIndex = headers.indexOf("JANコード");
          const rfidIndex = headers.indexOf("RFID ID");
          
          // Skip header row
          const result = [];
          for (let i = 1; i < data.length; i++) {
            const row = data[i];
            result.push({
              janCode: row[janCodeIndex],
              rfid: row[rfidIndex]
            });
          }
          
          return result;
        } catch (error) {
          console.error('Error in getRFIDListFromSheet:', error);
          return [];
        }
      }

      // JANコードの選択状態に応じてRFIDの選択を更新する関数
      function updateRFIDSelectionsByJANCode(checkbox) {
        const row = checkbox.closest('tr');
        const janCode = row.querySelector('.jan-code-input').value.trim();
        
        if (!janCode) {
          return; // JANコードが入力されていない場合は何もしない
        }
        
        console.log('Updating RFID selections for JAN code:', janCode);
        console.log('Checkbox state:', checkbox.checked);
        
        // RFIDテーブルの行を取得
        const rfidTable = document.getElementById("rfidTable");
        const tbody = rfidTable.getElementsByTagName("tbody")[0];
        const rows = tbody.getElementsByTagName("tr");
        
        let matchFound = false;
        
        // 各行をチェック
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          const rowJANCode = row.getAttribute("data-jan-code") || row.cells[1].textContent.trim();
          
          // デバッグログを追加
          console.log(`Row ${i+1} JAN comparison:`, {
            'Input JAN': janCode,
            'Table JAN': rowJANCode,
            'Equal?': rowJANCode === janCode
          });
          
          if (rowJANCode === janCode) {
            // JANコードが一致する場合、チェックボックスの状態を更新
            const selectCheckbox = row.querySelector(".rfid-checkbox");
            if (selectCheckbox) {
              selectCheckbox.checked = checkbox.checked;
              
              // チェックボックスの状態に応じて行の背景色を更新
              if (checkbox.checked) {
                // 一時的にハイライト
                row.style.transition = "background-color 0.5s";
                row.style.backgroundColor = '#e6ffe6';
                setTimeout(() => {
                  row.style.backgroundColor = '';
                }, 3000); // 3秒後に背景色を元に戻す
              } else {
                row.style.backgroundColor = '';
              }
            }
            matchFound = true;
          }
        }
        
        console.log('Match found:', matchFound);
        if (!matchFound && checkbox.checked) {
          console.log(`No matching RFID found for JAN code: ${janCode}`);
        }
      }
    </script>
  </body>
</html>
